// ===========================================
// MISSEDCALL AI - DATABASE SCHEMA
// ===========================================
// This defines all your database tables and relationships
// Run `npm run db:push` to sync this to your database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===========================================
// BUSINESS - Your customers (dentists, salons, etc.)
// ===========================================
model Business {
  id                    String    @id @default(cuid())

  // Basic info
  name                  String                          // "Smith Dental"
  slug                  String    @unique               // "smith-dental" (for URLs)

  // Telnyx phone number provisioned for this business
  telnyxPhoneNumber     String?   @unique
  forwardingNumber      String?                         // Owner's real phone number to ring first

  // Business details
  timezone              String    @default("America/New_York")
  businessHours         Json?                           // { monday: { open: "09:00", close: "17:00" }, ... }
  servicesOffered       Json?                           // ["cleaning", "filling", "crown", ...]

  // AI customization
  aiGreeting            String?                         // Custom first message
  aiInstructions        String?   @db.Text              // Custom personality/rules for the AI
  aiContext             String?   @db.Text              // Business context (what they do, policies, etc.)

  // Calendar integration (optional per business)
  calendarEnabled         Boolean   @default(false)
  googleAccessToken       String?   @db.Text
  googleRefreshToken      String?   @db.Text
  googleCalendarConnected Boolean   @default(false)
  slotDurationMinutes     Int       @default(30)   // Booking slot length (30 or 60)

  // Billing
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?
  subscriptionStatus    String    @default("trialing")  // trialing, active, past_due, canceled

  // Admin tracking
  adminNotes            String?   @db.Text              // Private notes only Jacob sees
  setupFee              Float?                           // What they paid upfront
  monthlyFee            Float?                           // What they pay monthly
  spamFilterEnabled     Boolean   @default(false)       // Premium feature - spam call filtering
  callScreenerEnabled   Boolean   @default(false)
  callScreenerMessage   String?
  missedCallVoiceMessage String?  @default("We're sorry we can't get to the phone right now. You should receive a text message shortly.")
  missedCallAiEnabled   Boolean   @default(true)        // Send AI SMS after missed call
  smsCooldownDays       Int?                            // Cooldown period in days (null = use env SMS_COOLDOWN_DAYS or default 7)

  // Owner notification preferences (booking created/cancelled)
  ownerEmail            String?                         // Business owner email for notifications
  ownerPhone            String?                         // Owner's phone for SMS (falls back to forwardingNumber)
  notifyBySms           Boolean   @default(true)        // Send SMS to owner on booking events
  notifyByEmail         Boolean   @default(true)        // Send email to owner on booking events

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relationships
  users                 User[]
  conversations         Conversation[]
  appointments          Appointment[]
  screenedCalls         ScreenedCall[]
  blockedNumbers        BlockedNumber[]
  contacts              Contact[]
  contactCooldowns      ContactCooldown[]
  cooldownSkipLogs      CooldownSkipLog[]
  telnyxUsageRecords    TelnyxUsageRecord[]

  @@index([stripeCustomerId])
}

// ===========================================
// TELNYX USAGE RECORD - Cached MDR/CDR cost data per business
// Stores actual Telnyx charges from Detail Record Search API
// ===========================================
model TelnyxUsageRecord {
  id              String   @id @default(cuid())
  businessId      String
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  recordType      String   // "sms" | "call"
  telnyxRecordId  String   @unique               // Telnyx MDR uuid or CDR id
  cost            Float    @default(0)           // USD amount charged by Telnyx

  occurredAt      DateTime
  metadata        Json?    // { durationSeconds?, from?, to?, direction?, ... }

  createdAt       DateTime @default(now())

  @@index([businessId])
  @@index([businessId, recordType])
  @@index([occurredAt])
}

// ===========================================
// CONTACT - Client's address book; skip automated SMS to existing contacts
// Numbers here are people the business already knows (no wasted texts)
// ===========================================
model Contact {
  id          String   @id @default(cuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  phoneNumber String   // Stored in normalized form for matching
  name        String?
  createdAt   DateTime @default(now())

  @@unique([businessId, phoneNumber])
  @@index([businessId])
}

// ===========================================
// BLOCKED NUMBER - Numbers that don't get MissedCall AI SMS
// ===========================================
model BlockedNumber {
  id          String   @id @default(cuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  phoneNumber String
  label       String?
  createdAt   DateTime @default(now())

  @@unique([businessId, phoneNumber])
  @@index([businessId])
}

// ===========================================
// USER - People who log into the dashboard
// ===========================================
model User {
  id                    String    @id @default(cuid())

  // Clerk integration
  clerkId               String    @unique               // Clerk's user ID

  // User info (synced from Clerk)
  email                 String
  firstName             String?
  lastName              String?
  imageUrl              String?

  // Role within the business
  role                  String    @default("owner")     // owner, admin, staff

  // Which business they belong to
  businessId            String
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([clerkId])
  @@index([businessId])
}

// ===========================================
// CONVERSATION - Each missed call = one conversation
// ===========================================
model Conversation {
  id                    String    @id @default(cuid())

  // Which business this belongs to
  businessId            String
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Caller info
  callerPhone           String                          // +1234567890
  callerName            String?                         // Gathered during conversation
  callSid               String?   @unique               // Call control ID (parent voice call)
  aLegCallControlId     String?                           // A-leg call_control_id stored when forwarding
  callConnected         Boolean   @default(false)         // True when B-leg (owner) answered â€” prevents missed-call SMS

  // Dial outcome (from voice-dial-status callback)
  dialCallStatus        String?                         // completed, no-answer, busy, failed, canceled
  answeredBy            String?                         // human, machine, fax, unknown
  durationSeconds       Int?                            // Dial leg duration in seconds
  callEndedAt           DateTime?                       // When the dial attempt ended

  // Conversation state
  status                String    @default("active")    // active, completed, appointment_booked, no_response, screening

  // AI-generated summary of the conversation
  summary               String?   @db.Text

  // SMS booking flow state: { step, slotsSent?, selectedSlot?, ... }
  bookingFlowState      Json?

  // What the caller needed (extracted by AI)
  intent                String?                         // "book_appointment", "question", "emergency", etc.
  serviceRequested      String?                         // "teeth cleaning", "oil change", etc.

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  lastMessageAt         DateTime  @default(now())

  // Relationships
  messages              Message[]
  appointment           Appointment?

  @@index([businessId])
  @@index([callerPhone])
  @@index([status])
  @@index([createdAt])
}

// ===========================================
// MESSAGE - Individual texts in a conversation
// ===========================================
model Message {
  id                    String    @id @default(cuid())

  // Which conversation this belongs to
  conversationId        String
  conversation          Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Message details
  direction             String                          // "inbound" (from caller) or "outbound" (from AI)
  content               String    @db.Text              // The actual message text

  // Telnyx tracking
  telnyxSid             String?                         // Telnyx message ID for tracking
  telnyxStatus          String?                         // sent, delivered, failed, etc.
  cost                  Float?                          // Actual cost from Telnyx MDR (USD)

  // Timestamps
  createdAt             DateTime  @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// ===========================================
// APPOINTMENT - When AI successfully books
// ===========================================
model Appointment {
  id                    String    @id @default(cuid())

  // Relationships
  businessId            String
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  conversationId        String?   @unique               // Null for web bookings
  conversation          Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  // Customer info
  customerName          String
  customerPhone         String
  customerEmail         String?

  // Appointment details
  serviceType           String                          // "teeth cleaning", "haircut", etc.
  scheduledAt           DateTime                        // When the appointment is
  duration              Int       @default(60)          // Duration in minutes
  notes                 String?   @db.Text              // Any special notes/requests

  // Source tracking (website vs sms)
  source                String    @default("website")  // "website" | "sms"

  // Calendar integration
  googleCalendarEventId String?

  // Status tracking
  status                String    @default("confirmed") // confirmed, cancelled, completed, no_show

  // Reminders
  reminderSentAt        DateTime?

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([businessId])
  @@index([scheduledAt])
  @@index([status])
}

// ===========================================
// PHONE NUMBER POOL - Available Telnyx numbers
// ===========================================
model PhoneNumber {
  id                    String    @id @default(cuid())

  phoneNumber           String    @unique               // +1234567890
  telnyxSid             String    @unique               // Telnyx phone number SID

  // Assignment
  assignedToBusinessId  String?                         // Which business is using this (null = available)

  // Status
  status                String    @default("available") // available, assigned, released

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([status])
}

// ===========================================
// CONTACT COOLDOWN - Tracks last automated message per phone number
// Used to enforce SMS cooldown (e.g. don't send to same number within 7 days)
// ===========================================
model ContactCooldown {
  id              String   @id @default(cuid())
  businessId      String
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  phoneNumber     String
  lastMessageSent DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([businessId, phoneNumber])
  @@index([businessId])
  @@index([phoneNumber])
}

// ===========================================
// COOLDOWN SKIP LOG - Tracks when messages are skipped due to cooldown
// For analytics / cost savings reporting
// ===========================================
model CooldownSkipLog {
  id              String   @id @default(cuid())
  businessId      String
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  phoneNumber     String
  reason          String   @default("cooldown")
  attemptedAt     DateTime @default(now())
  lastMessageSent DateTime
  messageType     String?                          // "missed_call", "ai_followup", etc.

  @@index([businessId])
  @@index([attemptedAt])
}

// ===========================================
// SCREENED CALL - Call screening / spam filter
// ===========================================
model ScreenedCall {
  id            String    @id @default(cuid())
  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  callerPhone   String
  callSid       String?
  result        String    @default("blocked")
  createdAt     DateTime  @default(now())

  @@index([businessId])
  @@index([businessId, result])
  @@index([createdAt])
}
